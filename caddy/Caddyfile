# ButcApp Production Caddy Configuration
# butcapp.com domain için Caddy yapılandırması

# Global settings
{
	email admin@butcapp.com
	admin localhost:2019
	log {
		output file /var/log/caddy/caddy.log {
			roll_size 100mb
			roll_keep 5
			roll_keep_for 720h
		}
		level INFO
	}
}

# Rate limiting
(rate_limit_api) {
	rate {
		zone api
		key {remote_host}
		events 20
		window 1s
	}
}

(rate_limit_general) {
	rate {
		zone general
		key {remote_host}
		events 40
		window 1s
	}
}

# Main domain configuration
butcapp.com {
	# Handle both HTTP and HTTPS automatically
	# Caddy will automatically redirect HTTP to HTTPS and handle SSL certificates
	
	# Security headers
	header {
		# HSTS
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		
		# Other security headers
		X-Frame-Options DENY
		X-Content-Type-Options nosniff
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "camera=(), microphone=(), geolocation=()"
		
		# Remove server signature
		-Server
	}
	
	# Handle API routes with rate limiting
	handle /api/* {
		import rate_limit_api
		
		# CORS headers for API
		@cors_preflight method OPTIONS
		handle @cors_preflight {
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
			respond "" 204
		}
		
		# Proxy to Next.js application
		reverse_proxy localhost:3001 {
			# HTTP/2 support
			transport http {
				tls_timeout 10s
				dial_timeout 10s
				expect_continue_timeout 1s
			}
			
			# Headers
			header_up Host {http.reverse_proxy.upstream.hostport}
			header_up X-Real-IP {http.request.remote_host}
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}, {http.request.remote_host}
			header_up X-Forwarded-Proto {http.request.scheme}
			header_up X-Forwarded-Host {http.request.host}
			
			# Timeouts
			buffer_requests
			dial_timeout 30s
			read_timeout 300s
			write_timeout 300s
		}
	}
	
	# Handle static files with caching
	handle_path /static/* {
		file_server
		header Cache-Control "public, max-age=31536000, immutable"
		header Expires "Thu, 31 Dec 2037 23:55:55 GMT"
	}
	
	# Handle public assets
	handle_path /_next/static/* {
		file_server
		header Cache-Control "public, max-age=31536000, immutable"
		header Expires "Thu, 31 Dec 2037 23:55:55 GMT"
	}
	
	# Handle images and other assets
	handle_path /*.{jpg,jpeg,png,gif,ico,css,js,woff,woff2,ttf,svg,webp,avif} {
		file_server
		header Cache-Control "public, max-age=31536000, immutable"
		header Expires "Thu, 31 Dec 2037 23:55:55 GMT"
	}
	
	# Health check endpoint
	handle /health {
		respond "healthy\n" 200
		header Content-Type "text/plain"
	}
	
	# Block common exploit attempts
	handle_path /*.{aspx,php,jsp,cgi} {
		respond "Not Found" 404
	}
	
	# Block access to sensitive files
	handle_path /.git/* {
		respond "Not Found" 404
	}
	
	handle_path /.env {
		respond "Not Found" 404
	}
	
	handle_path /.htaccess {
		respond "Not Found" 404
	}
	
	# Main application proxy
	import rate_limit_general
	reverse_proxy localhost:3001 {
		# HTTP/2 support
		transport http {
			tls_timeout 10s
			dial_timeout 10s
			expect_continue_timeout 1s
		}
		
		# Headers
		header_up Host {http.reverse_proxy.upstream.hostport}
		header_up X-Real-IP {http.request.remote_host}
		header_up X-Forwarded-For {http.request.header.X-Forwarded-For}, {http.request.remote_host}
		header_up X-Forwarded-Proto {http.request.scheme}
		header_up X-Forwarded-Host {http.request.host}
		
		# Timeouts
		buffer_requests
		dial_timeout 30s
		read_timeout 300s
		write_timeout 300s
		
		# WebSocket support
		header_up Connection {http.request.header.Connection}
		header_up Upgrade {http.request.header.Upgrade}
	}
	
	# Logging
	log {
		output file /var/log/caddy/butcapp-access.log {
			roll_size 100mb
			roll_keep 5
			roll_keep_for 720h
		}
		format json
	}
	
	# Error pages
	handle_errors {
		@500 expression {http.error.status_code} == 500
		handle @500 {
			respond "Internal Server Error" 500
		}
		
		@502 expression {http.error.status_code} == 502
		handle @502 {
			respond "Service Temporarily Unavailable" 502
		}
		
		@503 expression {http.error.status_code} == 503
		handle @503 {
			respond "Service Temporarily Unavailable" 503
		}
		
		@504 expression {http.error.status_code} == 504
		handle @504 {
			respond "Gateway Timeout" 504
		}
	}
}

# www subdomain redirect
www.butcapp.com {
	redir https://butcapp.com{uri} 301
}

# Optional: Staging subdomain
staging.butcapp.com {
	# Similar configuration but for staging environment
	reverse_proxy localhost:3002
}