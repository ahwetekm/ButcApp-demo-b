# ButcApp Production Caddy Configuration
# Compatible with Caddy 2.x

# Global settings
{
	email admin@butcapp.com
	admin localhost:2019
	log {
		output file /var/log/caddy/caddy.log {
			roll_size 100mb
			roll_keep 5
			roll_keep_for 720h
		}
		level INFO
	}
}

# Main domain configuration
butcapp.com {
	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Frame-Options DENY
		X-Content-Type-Options nosniff
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "camera=(), microphone=(), geolocation=()"
		-Server
	}
	
	# Handle API routes
	handle /api/* {
		# CORS headers for API
		@cors_preflight method OPTIONS
		handle @cors_preflight {
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
			respond "" 204
		}
		
		# Proxy to Next.js application
		reverse_proxy localhost:3001
	}
	
	# Handle static files with caching
	handle_path /static/* {
		file_server
		header Cache-Control "public, max-age=31536000, immutable"
	}
	
	# Handle public assets
	handle_path /_next/static/* {
		file_server
		header Cache-Control "public, max-age=31536000, immutable"
	}
	
	# Handle images and other assets
	handle_path /*.{jpg,jpeg,png,gif,ico,css,js,woff,woff2,ttf,svg,webp,avif} {
		file_server
		header Cache-Control "public, max-age=31536000, immutable"
	}
	
	# Health check endpoint
	handle /health {
		respond "healthy\n" 200
		header Content-Type "text/plain"
	}
	
	# Block common exploit attempts
	handle_path /*.{aspx,php,jsp,cgi} {
		respond "Not Found" 404
	}
	
	# Block access to sensitive files
	handle_path /.git/* {
		respond "Not Found" 404
	}
	
	handle_path /.env {
		respond "Not Found" 404
	}
	
	handle_path /.htaccess {
		respond "Not Found" 404
	}
	
	# Main application proxy
	reverse_proxy localhost:3001
	
	# Logging
	log {
		output file /var/log/caddy/butcapp-access.log {
			roll_size 100mb
			roll_keep 5
			roll_keep_for 720h
		}
		format json
	}
}

# www subdomain redirect
www.butcapp.com {
	redir https://butcapp.com{uri} 301
}